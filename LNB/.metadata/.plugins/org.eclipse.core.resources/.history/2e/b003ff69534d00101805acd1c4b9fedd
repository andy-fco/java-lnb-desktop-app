package DLL;

import java.sql.Connection;
import java.sql.Date;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.text.SimpleDateFormat;
import java.util.LinkedList;

import javax.swing.JOptionPane;


import BLL.Aficionado;
import BLL.Usuario;

public class DLLAficionado {

	private static Connection con = Conexion.getInstance().getConnection();

	// INGRESO
	public static Aficionado login(String id, String pass) {
		Aficionado user = new Aficionado();

		try {
			PreparedStatement stmt = con
					.prepareStatement("SELECT * FROM aficionados WHERE id_usuario = ? AND pass = ?");
			stmt.setString(1, id);
			stmt.setString(2, user.encriptar(pass));

			ResultSet rs = stmt.executeQuery();

			if (rs.next()) {
				String nombre = rs.getString("nombre");
				String apellido = rs.getString("apellido");
				String email = rs.getString("email");
				Date date = rs.getDate("d_of_birth");
				String dOfBirth = new SimpleDateFormat("dd-MM-yyyy").format(date);
//					Jugador jugadorFavorito
//					Equipo equipoFavorito
//					int puntos

				user = new Aficionado(nombre, apellido, id, pass, email, dOfBirth);
			}
		} catch (Exception e) {
			System.out.print("Error");
		}

		return user;
	}

	// LISTAR AFICIONADOS
	public static LinkedList<Aficionado> mostrarAficionados() {
		LinkedList<Aficionado> aficionados = new LinkedList<>();
		try {
			PreparedStatement stmt = con.prepareStatement("SELECT * FROM aficionados");
			ResultSet rs = stmt.executeQuery();

			while (rs.next()) {

				String nombre = rs.getString("nombre");
				String apellido = rs.getString("apellido");
				String id = rs.getString("id_usuario");
				String pass = rs.getString("pass");
				String email = rs.getString("email");
				String dOfBirth = rs.getString("d_of_birth");

				aficionados.add(new Aficionado(nombre, apellido, id, pass, email, dOfBirth));

			}
		} catch (Exception e) {
			e.printStackTrace();
		}
		return aficionados;
	}

	// REGISTRAR AFICIONADO
	public static Aficionado registro(String nombre, String apellido, String id, String pass,
	        String email, String dOfBirth) {

	    Aficionado nuevo = new Aficionado(nombre, apellido, id, pass, email, dOfBirth);

	        LinkedList<Aficionado> existentes = mostrarAficionados();
	        boolean esUnico = true;

	        for (Aficionado existente : existentes) {
	            if (existente.getEmail().equals(nuevo.getEmail()) || existente.getId().equals(nuevo.getId())) {
	                esUnico = false;
	                break;
	            }
	        }

	        if (esUnico) {
	            if (!DLLAdmin.agregarAficionado(nuevo)) {
	                nuevo = null;
	                JOptionPane.showMessageDialog(null, "Error al registrar el usuario");
	            }
	        } else {
	            JOptionPane.showMessageDialog(null, "Usuario ya existente (ID o email duplicado)");
	            nuevo = null;
	        }
	    

	    return nuevo;
	}
	
	//EDITAR AFICIONADO
	public static String editarAficionado(Aficionado aficionado) {
		try {
			PreparedStatement statement = con
					.prepareStatement("UPDATE aficionados SET nombre = ?, apellido = ?, id_usuario = ?, pass = ?, email = ?, d_of_birth = ? WHERE id_usuario = ?");
			statement.setString(1,aficionado.getNombre());
			statement.setString(2,aficionado.getNombre());
			statement.setString(3,aficionado.getId());
			statement.setString(4, aficionado.encriptar(aficionado.getPass()));
			statement.setString(5,aficionado.getEmail());
			statement.setDate(6, Date.valueOf(aficionado.getdOfBirth()));
			statement.setString(7, aficionado.getId());

			int filas = statement.executeUpdate();
			if (filas > 0) {
				return "Usuario editado correctamente.";
			}
			
		}catch (MySQLIntegrityConstraintViolationException e) {
			e.printStackTrace();
			return "Error, mail existente";

		} catch (Exception e) {
			e.printStackTrace();
		}
		return "error";

	}
	
}
